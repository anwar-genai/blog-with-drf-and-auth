{% extends 'base.html' %}
{% block title %}{{ post.title }}{% endblock %}
{% block content %}
  <div class="d-flex justify-content-between align-items-start mb-3">
    <div>
      <h1 class="mb-1">{{ post.title }}</h1>
      <div class="text-secondary small d-flex align-items-center gap-2">
        {% if post.author.profile and post.author.profile.avatar %}
          <img src="{{ post.author.profile.avatar.url }}" alt="avatar" class="rounded-circle" width="24" height="24">
        {% endif %}
        <span>by {{ post.author.username }} • {{ post.created_at|date:"M d, Y H:i" }}</span>
      </div>
    </div>
    <div>
      {% if request.user.is_authenticated %}
        <form method="post" action="/blog/post/{{ post.slug }}/like-toggle/">
          {% csrf_token %}
          <button class="btn btn-outline-danger" type="submit">{% if request.user in post.likes.all %}Unlike{% else %}Like{% endif %} ({{ post.likes_count }})</button>
        </form>
      {% endif %}
    </div>
  </div>

  <div class="mb-4">
    {% if post.is_poll %}
      <div class="mb-3" id="poll-container" data-slug="{{ post.slug }}">
        {% for opt in poll_options %}
          <div class="mb-3 poll-option">
            <div class="d-flex justify-content-between mb-1 align-items-center">
              <div class="form-check">
                <input class="form-check-input poll-choice" type="{% if post.max_choices > 1 %}checkbox{% else %}radio{% endif %}" name="poll_choice" id="opt-{{ opt.id }}" data-option-id="{{ opt.id }}" {% if opt.selected %}checked{% endif %} {% if not post.poll_is_open %}disabled{% endif %}>
                <label class="form-check-label" for="opt-{{ opt.id }}"><strong>{{ opt.text }}</strong></label>
              </div>
              <span class="text-secondary small"><span class="votes" data-id="{{ opt.id }}">{{ opt.votes }}</span> votes • {{ opt.percent }}%</span>
            </div>
            <div class="progress" role="progressbar" aria-label="{{ opt.text }}">
              <div class="progress-bar" data-id="{{ opt.id }}" style="width: {{ opt.percent }}%"></div>
            </div>
          </div>
        {% empty %}
          <p class="text-secondary">No options added.</p>
        {% endfor %}
        {% if not post.poll_is_open %}
          <div class="text-danger small">Poll is closed.</div>
        {% elif post.max_choices > 1 %}
          <div class="text-secondary small">Select up to {{ post.max_choices }} options.</div>
        {% endif %}
      </div>
      <script>
        (function(){
          const container = document.getElementById('poll-container');
          if(!container) return;
          const slug = container.getAttribute('data-slug');
          const inputs = container.querySelectorAll('.poll-choice');
          inputs.forEach(input => {
            input.addEventListener('change', async (e) => {
              const optionId = input.getAttribute('data-option-id');
              const res = await fetch(`/blog/post/${slug}/vote/${optionId}/`, {method:'POST', headers:{'X-Requested-With':'XMLHttpRequest','X-CSRFToken': getCookie('csrftoken')}});
              if(!res.ok){ return; }
              const data = await res.json();
              if(!data.ok){ return; }
              data.options.forEach(o => {
                const bar = container.querySelector(`.progress-bar[data-id="${o.id}"]`);
                if(bar){ bar.style.width = `${o.percent}%`; }
                const votes = container.querySelector(`.votes[data-id="${o.id}"]`);
                if(votes){ votes.innerText = o.votes; }
                const optInput = container.querySelector(`.poll-choice[data-option-id="${o.id}"]`);
                if(optInput){ optInput.checked = !!o.selected; }
              });
            });
          });
          function getCookie(name){
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
              const cookies = document.cookie.split(';');
              for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
                }
              }
            }
            return cookieValue;
          }
        })();
      </script>
    {% else %}
      <div class="post-content">{{ post.content|safe }}</div>
    {% endif %}
    {% if request.user == post.author %}
      <a class="btn btn-outline-primary btn-sm" href="/blog/post/{{ post.slug }}/edit/">Edit</a>
      <a class="btn btn-outline-danger btn-sm" href="/blog/post/{{ post.slug }}/delete/">Delete</a>
    {% endif %}
  </div>

  <h4 class="mb-3">Comments</h4>
  <div class="mb-3">
    {% for comment in post.comments.all %}
      <div class="comment-card p-3 mb-2 d-flex gap-2">
        <div>
          {% if comment.author.profile and comment.author.profile.avatar %}
            <img src="{{ comment.author.profile.avatar.url }}" alt="avatar" class="rounded-circle" width="36" height="36">
          {% else %}
            <div class="rounded-circle bg-secondary-subtle" style="width:36px;height:36px;"></div>
          {% endif %}
        </div>
        <div class="flex-grow-1">
          <div class="meta mb-1">{{ comment.author.username }} • {{ comment.created_at|date:"M d, Y H:i" }}</div>
          <div>{{ comment.content|linebreaks }}</div>
        </div>
      </div>
    {% empty %}
      <p class="text-secondary">No comments yet.</p>
    {% endfor %}
  </div>

  {% if request.user.is_authenticated %}
    <form method="post" action="/blog/post/{{ post.slug }}/comment/" class="comment-form">
      {% csrf_token %}
      <div class="mb-2">
        {{ comment_form.content.errors }}
        <textarea name="content" class="form-control" rows="3" placeholder="Add a comment..."></textarea>
      </div>
      <button class="btn btn-primary" type="submit">Add Comment</button>
    </form>
  {% else %}
    <p><a href="/accounts/login/">Login</a> to comment.</p>
  {% endif %}
{% endblock %}


