<div class="mb-3">
  {% include 'blog/_post_card.html' with post=post %}
</div>
<form id="reply-modal-form" method="post" action="/blog/post/{{ post.slug }}/comment/" hx-post="/blog/post/{{ post.slug }}/comment/" hx-swap="none" hx-push-url="false">
  {% csrf_token %}
  <input type="hidden" name="next" value="/blog/#post-{{ post.slug }}">
  <div class="d-flex gap-3">
    <div>
      {% if request.user.profile and request.user.profile.avatar %}
        <img class="avatar" src="{{ request.user.profile.avatar.url }}" alt="avatar">
      {% else %}
        <div class="avatar bg-secondary-subtle"></div>
      {% endif %}
    </div>
    <div class="flex-grow-1">
      <textarea name="content" class="form-control border-0 autosize" rows="1" placeholder="Post your reply"></textarea>
      <div class="d-flex justify-content-end mt-3">
        <button type="submit" class="btn btn-brand rounded-pill px-3">Reply</button>
      </div>
    </div>
  </div>
</form>
<script>
(function(){
  const form = document.getElementById('reply-modal-form');
  if(!form) return;
  // Autosize textarea
  const ta = form.querySelector('textarea.autosize');
  if(ta){
    function resize(){ ta.style.height = 'auto'; ta.style.height = Math.min(220, ta.scrollHeight) + 'px'; }
    ta.addEventListener('input', resize); resize();
  }
  document.body.addEventListener('htmx:afterRequest', function(ev){
    if(ev.target === form){
      try {
        const resp = ev.detail.xhr.responseText;
        let data; try { data = JSON.parse(resp); } catch(_){ data = null; }
        if(data && data.ok){
          const card = document.querySelector(`[data-post-slug='{{ post.slug }}']`);
          if(card){
            const countEl = card.querySelector('.comment-count');
            if(countEl){ countEl.textContent = String(parseInt(countEl.textContent||'0',10) + 1); }
          }
          const evt = new Event('reply:success'); document.body.dispatchEvent(evt);
        }
      } catch(err){}
    }
  });
})();
</script>

