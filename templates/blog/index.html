{% extends 'base.html' %}
{% block title %}Blog{% endblock %}
{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
    <h1 class="mb-0">Latest</h1>
    <form method="get" class="d-flex gap-2" role="search" id="search-form">
      <input type="search" class="form-control" name="q" id="search-input" placeholder="Search..." value="{{ request.GET.q }}">
      <select class="form-select" name="type">
        <option value="">All</option>
        <option value="article" {% if request.GET.type == 'article' %}selected{% endif %}>Articles</option>
        <option value="post" {% if request.GET.type == 'post' %}selected{% endif %}>Posts</option>
        <option value="poll" {% if request.GET.type == 'poll' %}selected{% endif %}>Polls</option>
      </select>
      <button class="btn btn-outline-secondary" type="submit">Filter</button>
    </form>
    {% if request.user.is_authenticated %}
      <div class="btn-group">
        <a class="btn btn-outline-primary" href="/blog/post/new/article/">New Article</a>
        <a class="btn btn-outline-success" href="/blog/post/new/status/">New Post</a>
        <a class="btn btn-outline-warning" href="/blog/post/new/poll/">New Poll</a>
      </div>
    {% endif %}
  </div>
  {% for post in posts %}
    <div class="card mb-3 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <h5 class="card-title mb-1"><a href="/blog/post/{{ post.slug }}/">{{ post.title|default_if_none:"(No title)" }}</a></h5>
            <div class="text-secondary small mb-2">by {{ post.author.username }} ‚Ä¢ {{ post.created_at|date:"M d, Y H:i" }} ‚Ä¢ ‚ù§Ô∏è {{ post.likes_count }}</div>
          </div>
          {% if post.type == 'article' %}
            <span class="badge text-bg-primary">üìù Article</span>
          {% elif post.type == 'post' %}
            <span class="badge text-bg-success">üí¨ Post</span>
          {% elif post.type == 'poll' %}
            <span class="badge text-bg-warning">üìä Poll</span>
          {% else %}
            <span class="badge text-bg-secondary">{{ post.type|title }}</span>
          {% endif %}
        </div>
        {% if post.type == 'poll' %}
          <div class="small text-secondary">Poll ‚Ä¢ {{ post.poll_options.count }} options</div>
          <ul class="small text-secondary mb-2">
            {% for opt in post.poll_options.all|slice:':3' %}
              <li>{{ opt.text }}</li>
            {% endfor %}
            {% if post.poll_options.count > 3 %}
              <li>+{{ post.poll_options.count|add:'-3' }} more‚Ä¶</li>
            {% endif %}
          </ul>
        {% else %}
          <p class="card-text">{{ post.content|striptags|truncatewords:40 }}</p>
        {% endif %}
        <a class="card-link" href="/blog/post/{{ post.slug }}/">Read more</a>
      </div>
    </div>
  {% empty %}
    <p>No posts yet.</p>
  {% endfor %}
  {% if posts.paginator.num_pages > 1 %}
    <nav aria-label="Page navigation">
      <ul class="pagination justify-content-center mt-4">
        {% if posts.has_previous %}
          <li class="page-item"><a class="page-link" href="?page={{ posts.previous_page_number }}">Previous</a></li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">Previous</span></li>
        {% endif %}

        {% for num in posts.paginator.page_range %}
          {% if num == posts.number %}
            <li class="page-item active" aria-current="page"><span class="page-link">{{ num }}</span></li>
          {% else %}
            <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
          {% endif %}
        {% endfor %}

        {% if posts.has_next %}
          <li class="page-item"><a class="page-link" href="?page={{ posts.next_page_number }}">Next</a></li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">Next</span></li>
        {% endif %}
      </ul>
    </nav>
  {% endif %}
  <script>
    (function(){
      const input = document.getElementById('search-input');
      const form = document.getElementById('search-form');
      if(!input || !form) return;
      let t=null; input.addEventListener('input', function(){
        clearTimeout(t); t = setTimeout(()=> form.submit(), 400);
      });
    })();
  </script>
{% endblock %}


